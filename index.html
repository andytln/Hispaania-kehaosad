<!DOCTYPE html>
<html lang="et">
<head>
  <meta charset="UTF-8" />
  <title>Hispaania keel ‚Äì Kehaosad, numbrid, p√§evad ja suunad</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <!-- PWA & iOS asjad -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="ES √µppe√§pp" />
  <link rel="apple-touch-icon" href="icon-192.png" />

  <link rel="manifest" href="manifest.json" />

  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 40px auto;
      padding: 20px;
      border: 1px solid #ccc;
      border-radius: 12px;
    }
    h1, h2, h3 {
      text-align: center;
    }
    button {
      padding: 10px 16px;
      margin: 6px 4px;
      font-size: 16px;
      cursor: pointer;
    }
    input[type="text"] {
      width: 100%;
      padding: 8px;
      font-size: 16px;
      margin: 8px 0;
    }
    #estonian-word {
      font-size: 22px;
      font-weight: bold;
      margin: 12px 0;
    }
    #feedback {
      margin-top: 10px;
      font-size: 18px;
      font-weight: bold;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    table, th, td {
      border: 1px solid #888;
    }
    th, td {
      padding: 8px;
      text-align: left;
    }
    th {
      background: #f0f0f0;
    }
    #quiz-area {
      margin-top: 20px;
    }
    #mode-select {
      text-align: center;
      margin-bottom: 10px;
    }
    #mode-select p {
      margin-bottom: 8px;
    }
    #top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }
    #top-bar-title {
      flex: 1;
      text-align: center;
      font-weight: bold;
    }
    .correct-row {
      background-color: #d4edda; /* hele roheline */
    }
    .wrong-row {
      background-color: #f8d7da; /* hele punane */
    }
    #last-result {
      margin-top: 20px;
    }
    #vocab-area { display: none; margin-top: 20px; }
    .inline-input { display:flex; gap:8px; align-items:center; }
    .small-btn { padding:8px 10px; font-size:14px; }
    .list-note { font-size:14px; color:#555; margin-top:6px; }
  </style>
</head>
<body>
  <h1>Hispaania keel ‚Äì Kehaosad, numbrid, p√§evad ja suunad</h1>

  <div id="initial-select">
    <p>Vali: </p>
    <button id="select-vocab">S√µnavara (vaata s√µnu)</button>
    <button id="select-quiz">Kontrolli s√µnu</button>
  </div>

  <!-- S√µnavara ala: kolme nupuga ja tabeliga -->
  <div id="vocab-area">
    <div id="vocab-buttons" style="text-align:center; margin-bottom:8px;">
      <button id="vocab-body">Kehaosad</button>
      <button id="vocab-numbers">Numbrid (1‚Äì100, sajad, tuhanded)</button>
      <button id="vocab-days">P√§evad ja suunad</button>
      <button id="vocab-back" class="small-btn">Tagasi</button>
    </div>
    <div id="vocab-note" class="list-note">Vali √ºks kategooria, et n√§ha selle s√µnu, mida hetkel saab kontrollida.</div>
    <div id="vocab-list"></div>
  </div>

  <!-- Quiz ala (p√ºsib peaaegu sama nagu enne) -->
  <div id="quiz-area" style="display:none;">
    <div id="top-bar">
      <button id="restart-btn">Alusta uuesti</button>
      <div id="top-bar-title"><span id="mode-title"></span></div>
      <button id="cancel-btn">Katkesta</button>
    </div>

    <div id="mode-select" style="margin-top:10px; text-align:center;">
      <p>Vali blokk, mida harjutada:</p>
      <button id="mode-body">Kehaosad</button>
      <button id="mode-numbers">Numbrid (1‚Äì100, sajad, tuhanded)</button>
      <button id="mode-days">P√§evad ja suunad</button>
    </div>

    <p id="instructions"></p>

    <div id="estonian-word">Vajuta ‚ÄúJ√§rgmine‚Äù</div>

    <label>
      Sinu vastus hispaania keeles:
      <div class="inline-input">
        <input type="text" id="answer-input" autocomplete="off" />
        <button id="mic-btn" class="small-btn" title="Alusta h√§√§ltuvastust (t√§idab vastuskasti)">üé§</button>
        <button id="check-btn-inline" class="small-btn">Kontrolli</button>
      </div>
    </label>
    <br />
 
    <button id="check-btn">Kontrolli</button>
    <button id="next-btn">J√§rgmine</button>

    <div id="feedback"></div>

    <div id="last-result"></div>
  </div>

  <div id="summary"></div>

  <script>
    // -------- ANDMED --------

    const bodyWords = [
      { et: "pea", es: ["cabeza", "la cabeza", "cabecita", "el coco"] },
      { et: "silm", es: ["ojo", "el ojo", "ojito", "ojitos"] },
      { et: "nina", es: ["nariz", "la nariz", "naricita", "napia"] },
      { et: "suu", es: ["boca", "la boca", "boquita"] },
      { et: "hammas", es: ["diente", "el diente", "dientecito", "muela", "la muela"] },
      { et: "keel", es: ["lengua", "la lengua", "leng√ºita", "lenguita"] },
      { et: "k√µrv", es: ["oreja", "la oreja", "orejita", "orejitas"] },
      { et: "kael", es: ["cuello", "el cuello", "cuellito"] },
      { et: "√µlg", es: ["hombro", "el hombro", "hombrito"] },
      { et: "k√§si (randmest allpool)", es: ["mano", "la mano", "manita", "manitas"] },
      { et: "s√µrm", es: ["dedo", "el dedo", "dedito", "deditos"] },
      { et: "rind", es: ["pecho", "el pecho", "pechito", "pechitos"] },
      { et: "selg", es: ["espalda", "la espalda", "espaldita"] },
      {
        et: "k√µht",
        es: [
          "barriga", "la barriga",
          "estomago", "est√≥mago",
          "el estomago", "el est√≥mago",
          "panza", "la panza", "pancita", "tripita"
        ]
      },
      { et: "jalg", es: ["pierna", "la pierna", "piernita", "piernitas"] },
      { et: "p√µlv", es: ["rodilla", "la rodilla", "rodillita"] },
      {
        et: "varvas",
        es: [
          "dedo del pie", "el dedo del pie",
          "deditos del pie", "deditos"
        ]
      },
      {
        et: "tagumik",
        es: [
          "culo", "el culo",
          "trasero", "el trasero",
          "pompis",
          "nalgas", "las nalgas"
        ]
      },
      { et: "naeratus", es: ["sonrisa", "la sonrisa", "sonrisita"] },
      { et: "ripsmed", es: ["pesta√±as", "las pesta√±as", "pesta√±itas"] },
      { et: "huuled", es: ["labios", "los labios", "labiecitos"] },
      { et: "p√µsk", es: ["mejilla", "la mejilla", "cachete", "el cachete", "cachetito"] },
      { et: "p√µsed", es: ["mejillas", "las mejillas", "cachetes", "los cachetes"] },
      { et: "kulm", es: ["ceja", "la ceja", "cejita"] },
      { et: "kulmud", es: ["cejas", "las cejas", "cejitas"] },
      {
        et: "meeste suguelund",
        es: [
          "pene", "el pene",
          "pito",
          "verga",
          "mi cosita",
          "pajarito"
        ]
      },
      {
        et: "naiste suguelund",
        es: [
          "vagina", "la vagina",
          "chocho",
          "chucha",
          "pucha",
          "cosita",
          "chuchita"
        ]
      }
    ];

    const daysAndDirs = [
      { et: "esmasp√§ev", es: ["lunes", "el lunes"] },
      { et: "teisip√§ev", es: ["martes", "el martes"] },
      { et: "kolmap√§ev", es: ["mi√©rcoles", "miercoles", "el mi√©rcoles", "el miercoles"] },
      { et: "neljap√§ev", es: ["jueves", "el jueves"] },
      { et: "reede", es: ["viernes", "el viernes"] },
      { et: "laup√§ev", es: ["s√°bado", "sabado", "el s√°bado", "el sabado"] },
      { et: "p√ºhap√§ev", es: ["domingo", "el domingo"] },

      { et: "p√µhi", es: ["norte", "el norte"] },
      { et: "l√µuna", es: ["sur", "el sur"] },
      { et: "ida", es: ["este", "el este"] },
      { et: "l√§√§s", es: ["oeste", "el oeste"] },

      { et: "√ºles", es: ["arriba", "hacia arriba"] },
      // parandatud: 'hacia alla' -> 'hacia abajo' (√µige vastus s√µnale "alla")
      { et: "alla", es: ["abajo", "hacia abajo"] },
      { et: "vasakule", es: ["a la izquierda", "izquierda"] },
      { et: "paremale", es: ["a la derecha", "derecha"] },
      { et: "edasi", es: ["adelante", "hacia adelante", "recto", "sigue recto"] },
      { et: "tagasi", es: ["atr√°s", "atras", "hacia atr√°s", "hacia atras"] }
    ];

    function spanishNumber(n) {
      n = Number(n);
      if (!Number.isInteger(n) || n <= 0 || n > 9999) return String(n);

      const units = ["", "uno", "dos", "tres", "cuatro", "cinco", "seis", "siete", "ocho", "nueve"];
      const teens = { 10: "diez", 11: "once", 12: "doce", 13: "trece", 14: "catorce", 15: "quince" };
      const tensWords = {
        2: "veinte",
        3: "treinta",
        4: "cuarenta",
        5: "cincuenta",
        6: "sesenta",
        7: "setenta",
        8: "ochenta",
        9: "noventa"
      };
      const hundredsWords = {
        1: "ciento",
        2: "doscientos",
        3: "trescientos",
        4: "cuatrocientos",
        5: "quinientos",
        6: "seiscientos",
        7: "setecientos",
        8: "ochocientos",
        9: "novecientos"
      };

      if (n <= 9) return units[n];
      if (n >= 10 && n <= 15) return teens[n];
      if (n < 20) return "dieci" + units[n - 10];

      if (n === 20) return "veinte";
      if (n > 20 && n < 30) return "veinti" + units[n - 20];

      if (n < 100) {
        const t = Math.floor(n / 10);
        const u = n % 10;
        if (u === 0) return tensWords[t];
        return tensWords[t] + " y " + units[u];
      }

      if (n === 100) return "cien";
      if (n < 200) return "ciento " + spanishNumber(n - 100);

      if (n < 1000) {
        const h = Math.floor(n / 100);
        const r = n % 100;
        if (r === 0) return hundredsWords[h];
        return hundredsWords[h] + " " + spanishNumber(r);
      }

      if (n === 1000) return "mil";
      if (n < 2000) return "mil " + spanishNumber(n - 1000);

      const thousands = Math.floor(n / 1000);
      const rem = n % 1000;
      const thousandsPart = spanishNumber(thousands) + " mil";
      if (rem === 0) return thousandsPart;
      return thousandsPart + " " + spanishNumber(rem);
    }

    function buildNumberWords() {
      const pool = [];
      for (let i = 1; i <= 100; i++) pool.push(i);
      for (let i = 1; i <= 9; i++) pool.push(i * 100);
      for (let i = 1; i <= 9; i++) pool.push(i * 1000);

      const shuffled = pool.sort(function() { return Math.random() - 0.5; });
      const selected = shuffled.slice(0, 10);

      return selected.map(function(n) {
        const word = spanishNumber(n);
        return {
          et: String(n),
          es: [word, String(n)]
        };
      });
    }

    // -------- MUUTUJAD --------

    let currentWords = [];
    let currentWord = null;
    let usedIndices = [];
    let results = [];
    let currentMode = null;
    let lastResult = null; // ainult VIIMANE vastatud k√ºsimus

    // Speech Recognition
    let recognition = null;
    let recognizing = false;

    // -------- ABI --------

    function normalize(str) {
      // kaitse null/undefined eest
      return String(str || "")
        .toLowerCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .trim();
    }

    function speak(text, lang) {
      if (!("speechSynthesis" in window)) return;
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = lang;
      window.speechSynthesis.speak(utterance);
    }

    function showInitial() {
      document.getElementById("initial-select").style.display = "block";
      document.getElementById("vocab-area").style.display = "none";
      document.getElementById("quiz-area").style.display = "none";
    }

    function renderLastResult() {
      const div = document.getElementById("last-result");
      if (!lastResult) {
        div.innerHTML = "";
        return;
      }
      const rowClass = lastResult.ok ? "correct-row" : "wrong-row";
      let html = "<h3>Eelmine k√ºsimus</h3>";
      html += '<table><tr><th>Eesti</th><th>Sinu vastus</th><th>√ïige(d)</th></tr>';
      html += `<tr class="${rowClass}">
                 <td>${lastResult.et}</td>
                 <td>${lastResult.user}</td>
                 <td>${lastResult.correct}</td>
               </tr>`;
      html += "</table>";
      div.innerHTML = html;
    }

    function startMode(mode) {
      currentMode = mode;
      usedIndices = [];
      results = [];
      lastResult = null;
      currentWord = null;
      document.getElementById("feedback").textContent = "";
      document.getElementById("answer-input").value = "";
      document.getElementById("summary").innerHTML = "";
      renderLastResult();

      if (mode === "body") {
        currentWords = bodyWords.slice();
        document.getElementById("mode-title").textContent = "Kehaosad";
        document.getElementById("instructions").textContent =
          "Kuvatakse kehaosa eesti keeles. Kirjuta hispaaniakeelne vastus (v√µid kasutada ka sl√§ngi). K√µik s√µnad k√ºsitakse korra.";
      } else if (mode === "numbers") {
        currentWords = buildNumberWords();
        document.getElementById("mode-title").textContent = "Numbrid";
        document.getElementById("instructions").textContent =
          "K√ºsitakse 10 erinevat numbrit (1‚Äì100, sajad, tuhanded). V√µid vastata hispaania s√µnaga v√µi lihtsalt numbriga.";
      } else if (mode === "days") {
        currentWords = daysAndDirs.slice();
        document.getElementById("mode-title").textContent = "P√§evad ja suunad";
        document.getElementById("instructions").textContent =
          "K√ºsitakse n√§dalap√§evi, ilmakaari ja suundi (√ºles, alla, vasakule, paremale, edasi, tagasi). Kirjuta hispaaniakeelne vastus.";
      }

      document.getElementById("initial-select").style.display = "none";
      document.getElementById("vocab-area").style.display = "none";
      document.getElementById("quiz-area").style.display = "block";

      pickNewWord();
    }

    function pickNewWord() {
      if (!currentWords.length) return;

      if (usedIndices.length === currentWords.length) {
        showSummary();
        return;
      }

      let index;
      do {
        index = Math.floor(Math.random() * currentWords.length);
      } while (usedIndices.includes(index));

      usedIndices.push(index);
      currentWord = currentWords[index];

      document.getElementById("estonian-word").textContent = currentWord.et;
      document.getElementById("answer-input").value = "";
      document.getElementById("feedback").textContent = "";
      document.getElementById("answer-input").focus();
    }

    function checkAnswer() {
      if (!currentWord) return;

      const inputRaw = document.getElementById("answer-input").value;
      const input = normalize(inputRaw);
      if (!input) {
        document.getElementById("feedback").textContent =
          "Kirjuta palun vastus enne kontrollimist.";
        return;
      }

      const correctNormalized = currentWord.es.map(normalize);
      const isCorrect = correctNormalized.includes(input);

      const feedback = document.getElementById("feedback");
      const correctText = currentWord.es.join(", ");

      const row = {
        et: currentWord.et,
        user: inputRaw,
        correct: correctText,
        ok: isCorrect
      };

      results.push(row);
      lastResult = row;
      renderLastResult();

      if (isCorrect) {
        feedback.textContent = "√ïIGE! ‚úÖ ‚Äì " + correctText;
      } else {
        feedback.textContent = "‚ùå Vale. √ïige(d): " + correctText;
      }

      speak(currentWord.es[0], "es-ES");
    }

    function renderSummary() {
      const summaryDiv = document.getElementById("summary");
      summaryDiv.innerHTML = "";

      if (!results.length) {
        summaryDiv.innerHTML = "<h2>Kokkuv√µte</h2><p>√úhtegi vastust ei j√µudnud anda.</p>";
        return;
      }

      const correctCount = results.filter(r => r.ok).length;
      let html = "<h2>Kokkuv√µte</h2>" +
                 "<p>√ïigeid vastuseid: " + correctCount + " / " + results.length + "</p>";

      html += "<table><tr><th>Eesti s√µna / number</th><th>Sinu vastus</th><th>√ïige(d)</th></tr>";

      results.forEach(function(row) {
        const rowClass = row.ok ? "correct-row" : "wrong-row";
        html += '<tr class="' + rowClass + '">';
        html += "<td>" + row.et + "</td>";
        html += "<td>" + row.user + "</td>";
        html += "<td>" + row.correct + "</td>";
        html += "</tr>";
      });

      html += "</table>";

      summaryDiv.innerHTML = html;
    }

    function showSummary() {
      // N√§ita kokkuv√µtet seni antud vastustest ja vii kasutaja tagasi blokkide valikusse
      document.getElementById("quiz-area").style.display = "none";
      renderSummary();
      document.getElementById("initial-select").style.display = "block";
    }

    function restartApp() {
      currentMode = null;
      currentWords = [];
      usedIndices = [];
      results = [];
      lastResult = null;
      currentWord = null;
      document.getElementById("feedback").textContent = "";
      document.getElementById("answer-input").value = "";
      document.getElementById("summary").innerHTML = "";
      document.getElementById("estonian-word").textContent =
        "Vali uuesti blokk ja vajuta ‚ÄúJ√§rgmine‚Äù.";
      renderLastResult();
      showInitial();
    }

    // -------- S√µnavara vaatamine --------
    function showVocab(category) {
      const listDiv = document.getElementById('vocab-list');
      let items = [];
      if (category === 'body') items = bodyWords.slice();
      else if (category === 'days') items = daysAndDirs.slice();
      else if (category === 'numbers') items = buildNumberWords();

      let html = '<h3>S√µnavara: ' + (category === 'body' ? 'Kehaosad' : category === 'days' ? 'P√§evad ja suunad' : 'Numbrid') + '</h3>';
      html += "<table><tr><th>Eesti</th><th>Hispaania (n√§ide)</th></tr>";
      items.forEach(function(it) {
        html += '<tr><td>' + it.et + '</td><td>' + (Array.isArray(it.es) ? it.es.slice(0,3).join(', ') : it.es) + '</td></tr>';
      });
      html += '</table>';
      listDiv.innerHTML = html;
    }

    // -------- NUPUD --------

    const selectVocabBtn = document.getElementById('select-vocab');
    const selectQuizBtn = document.getElementById('select-quiz');
    const vocabArea = document.getElementById('vocab-area');
    const vocabBodyBtn = document.getElementById('vocab-body');
    const vocabNumbersBtn = document.getElementById('vocab-numbers');
    const vocabDaysBtn = document.getElementById('vocab-days');
    const vocabBackBtn = document.getElementById('vocab-back');

    const modeBodyBtn = document.getElementById("mode-body");
    const modeNumbersBtn = document.getElementById("mode-numbers");
    const modeDaysBtn = document.getElementById("mode-days");
    const nextBtn = document.getElementById("next-btn");
    const checkBtn = document.getElementById("check-btn");
    const checkBtnInline = document.getElementById("check-btn-inline");
    const restartBtn = document.getElementById("restart-btn");
    const cancelBtn = document.getElementById("cancel-btn");
    const answerInput = document.getElementById("answer-input");
    const micBtn = document.getElementById('mic-btn');

    selectVocabBtn.onclick = function() {
      document.getElementById('initial-select').style.display = 'none';
      vocabArea.style.display = 'block';
      document.getElementById('vocab-note').textContent = 'Vali kategooria, et n√§ha tabelit s√µnadest, mida hetkel saab kontrollida.';
      document.getElementById('vocab-list').innerHTML = '';
    };
    selectQuizBtn.onclick = function() {
      document.getElementById('initial-select').style.display = 'none';
      vocabArea.style.display = 'none';
      document.getElementById('quiz-area').style.display = 'block';
    };

    vocabBodyBtn.onclick = function() { showVocab('body'); };
    vocabNumbersBtn.onclick = function() { showVocab('numbers'); };
    vocabDaysBtn.onclick = function() { showVocab('days'); };
    vocabBackBtn.onclick = function() { showInitial(); };

    modeBodyBtn.onclick = function() { startMode("body"); };
    modeNumbersBtn.onclick = function() { startMode("numbers"); };
    modeDaysBtn.onclick = function() { startMode("days"); };
    nextBtn.onclick = function() { pickNewWord(); };
    checkBtn.onclick = function() { checkAnswer(); };
    checkBtnInline.onclick = function() { checkAnswer(); };
    // n√º√ºd: Alusta uuesti n√§itab kokkuv√µtet seni antud vastustest (sama nagu Katkesta)
    restartBtn.onclick = function() { showSummary(); };
    // Katkesta: n√§ita kokkuv√µtet seni antud vastustest
    cancelBtn.onclick = function() { showSummary(); };

    answerInput.addEventListener("keydown", function(e) {
      if (e.key === "Enter") {
        checkAnswer();
      }
    });

    // Speech recognition setup - t√§idab vastuskasti, ei tee automaatset kontrolli
    function setupRecognition() {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) return null;
      const r = new SpeechRecognition();
      r.lang = 'es-ES';
      r.interimResults = false;
      r.maxAlternatives = 1;
      r.onresult = function(event) {
        const transcript = event.results[0][0].transcript || '';
        answerInput.value = transcript;
      };
      r.onstart = function() { recognizing = true; micBtn.textContent = '‚è∫Ô∏è'; };
      r.onend = function() { recognizing = false; micBtn.textContent = 'üé§'; };
      r.onerror = function(e) { recognizing = false; micBtn.textContent = 'üé§'; console.error('Speech recognition error', e); };
      return r;
    }

    micBtn.addEventListener('click', function() {
      if (!recognition) {
        recognition = setupRecognition();
        if (!recognition) {
          alert('Sinu brauser ei toeta h√§√§ltuvastust. Proovi Chrome/Edge mobiil v√µi t√∂√∂laud.');
          return;
        }
      }
      if (recognizing) {
        recognition.stop();
      } else {
        try {
          recognition.start();
        } catch (e) {
          // Firefox v√µib visata kui start kutsutud mitu korda
          console.error(e);
        }
      }
    });

    // PWA service worker
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", function() {
        navigator.serviceWorker.register("service-worker.js").catch(function(e){console.error(e);});
      });
    }

    // show initial view on load
    showInitial();
  </script>
</body>

</html>
