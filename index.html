<!DOCTYPE html>
<html lang="et">
<head>
  <meta charset="UTF-8" />
  <title>Hispaania keel – Kehaosad, numbrid, päevad ja suunad</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <!-- PWA & iOS asjad -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="ES õppeäpp" />
  <link rel="apple-touch-icon" href="icon-192.png" />

  <link rel="manifest" href="manifest.json" />

  <style>
    /* Hispaania lipu triibud taustal (punane - kollane - punane) */
    html, body { height: 100%; margin: 0; }
    body {
      background: linear-gradient(to bottom, #A40000 0%, #A40000 22%, #FFD100 22%, #FFD100 78%, #A40000 78%, #A40000 100%);
      font-family: Arial, sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      padding: 20px 12px 40px;
      box-sizing: border-box;
    }
    .app {
      background: rgba(255,255,255,0.96);
      max-width: 900px;
      background: rgba(255,255,255,0.97);
      max-width: 980px;
      width: 100%;
      margin: 0 auto;
      padding: 20px 24px;
      border: 1px solid #ccc;
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.15);
    }
    h1, h2, h3 {
      text-align: center;
    }
    h1, h2, h3 { text-align: center; }
    button {
      padding: 10px 16px;
      margin: 6px 4px;
      font-size: 16px;
      cursor: pointer;
    }
    input[type="text"] {
      width: 100%;
      padding: 8px;
      font-size: 16px;
      margin: 8px 0;
    }
    #estonian-word {
      font-size: 22px;
      font-weight: bold;
      margin: 12px 0;
    }
    #feedback {
      margin-top: 10px;
      font-size: 18px;
      font-weight: bold;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    table, th, td {
      border: 1px solid #888;
    }
    th, td {
      padding: 8px;
      text-align: left;
    }
    th {
      background: #f0f0f0;
    }
    #quiz-area {
      margin-top: 20px;
    }
    #mode-select {
      text-align: center;
      margin-bottom: 10px;
    }
    #mode-select p {
      margin-bottom: 8px;
    }
    #top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }
    #top-bar-title {
      flex: 1;
      text-align: center;
      font-weight: bold;
    }
    .correct-row {
      background-color: #d4edda; /* hele roheline */
    }
    .wrong-row {
      background-color: #f8d7da; /* hele punane */
    }
    #last-result {
      margin-top: 20px;
    }
    #estonian-word { font-size: 22px; font-weight: bold; margin: 12px 0; }
    #feedback { margin-top: 10px; font-size: 18px; font-weight: bold; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    table, th, td { border: 1px solid #888; }
    th, td { padding: 8px; text-align: left; }
    th { background: #f0f0f0; }
    #quiz-area { margin-top: 20px; }
    #mode-select { text-align: center; margin-bottom: 10px; }
    #mode-select p { margin-bottom: 8px; }
    #top-bar { display: flex; justify-content: space-between; align-items: center; gap: 10px; }
    #top-bar-title { flex: 1; text-align: center; font-weight: bold; }
    .correct-row { background-color: #d4edda; }
    .wrong-row { background-color: #f8d7da; }
    #last-result { margin-top: 20px; }
    #vocab-area { display: none; margin-top: 20px; }
    .inline-input { display:flex; gap:8px; align-items:center; }
    .small-btn { padding:8px 10px; font-size:14px; }
    .list-note { font-size:14px; color:#555; margin-top:6px; }
    .pill-row { display:flex; flex-wrap:wrap; justify-content:center; gap:8px; margin:10px 0; }
    .pill-row button { border-radius:20px; border:1px solid #999; background:#f7f7f7; }
    .pill-row button.active { background:#ffe69b; border-color:#c58c00; }
    .vocab-nav { display:flex; justify-content:space-between; gap:10px; margin-top:8px; align-items:center; }
    .vocab-nav button { flex:1; }
    .muted { color:#666; font-size:14px; }
  </style>
</head>
<body>
  <div class="app">
    <h1>Hispaania keel – Kehaosad, numbrid, päevad ja suunad</h1>

    <div id="initial-select">
      <p>Vali: </p>
      <button id="select-vocab">Sõnavara (vaata sõnu)</button>
      <button id="select-quiz">Kontrolli sõnu</button>
    </div>

    <!-- Sõnavara ala: kolme nupuga ja tabeliga -->
    <div id="vocab-area">
      <div id="vocab-buttons" style="text-align:center; margin-bottom:8px;">
      <div id="vocab-buttons" class="pill-row">
        <button id="vocab-body">Kehaosad</button>
        <button id="vocab-numbers">Numbrid (1–20, 25, 30, kümnesed...)</button>
        <button id="vocab-days">Päevad ja suunad</button>
        <button id="vocab-back" class="small-btn">Tagasi</button>
      </div>
      <div id="vocab-note" class="list-note">Vali üks kategooria, et näha selle sõnu, mida hetkel saab kontrollida.</div>
      <div id="vocab-list"></div>
    </div>

    <!-- Quiz ala -->
    <div id="quiz-area" style="display:none;">
      <div id="top-bar">
        <button id="restart-btn">Alusta uuesti</button>
        <div id="top-bar-title"><span id="mode-title"></span></div>
        <button id="cancel-btn">Katkesta</button>
      </div>

      <div id="mode-select" style="margin-top:10px; text-align:center;">
        <p>Vali blokk, mida harjutada:</p>
        <button id="mode-body">Kehaosad</button>
        <button id="mode-numbers">Numbrid (1–1000)</button>
        <button id="mode-days">Päevad ja suunad</button>
      </div>

      <p id="instructions"></p>
@@ -311,85 +272,116 @@
        const u = n % 10;
        if (u === 0) return tensWords[t];
        return tensWords[t] + (t === 2 ? "" : " y ") + units[u];
      }

      if (n === 100) return "cien";
      if (n < 200) return "ciento " + spanishNumber(n - 100);

      if (n < 1000) {
        const h = Math.floor(n / 100);
        const r = n % 100;
        if (r === 0) return hundredsWords[h];
        return hundredsWords[h] + " " + spanishNumber(r);
      }

      if (n === 1000) return "mil";
      if (n < 2000) return "mil " + spanishNumber(n - 1000);

      const thousands = Math.floor(n / 1000);
      const rem = n % 1000;
      const thousandsPart = spanishNumber(thousands) + " mil";
      if (rem === 0) return thousandsPart;
      return thousandsPart + " " + spanishNumber(rem);
    }

    function buildNumberVocab() {
      const items = [];
      for (let i = 1; i <= 20; i++) items.push({ et: String(i), es: [spanishNumber(i), String(i)] });
      [25, 30].forEach(n => items.push({ et: String(n), es: [spanishNumber(n), String(n)] }));
      [40,50,60,70,80,90,100].forEach(n => items.push({ et: String(n), es: [spanishNumber(n), String(n)] }));
      for (let h = 1; h <= 9; h++) items.push({ et: String(h*100), es: [spanishNumber(h*100), String(h*100)] });
      items.push({ et: "1000", es: [spanishNumber(1000), "1000"] });
      [31,42,53,64,75,86,97].forEach(n => items.push({ et: String(n), es: [spanishNumber(n), String(n)] }));
      return items;
    function buildNumberVocabGroups() {
      return [
        {
          title: "1–10",
          items: Array.from({ length: 10 }, (_, i) => i + 1)
            .map(n => ({ et: String(n), es: [spanishNumber(n), String(n)] }))
        },
        {
          title: "11–20",
          items: Array.from({ length: 10 }, (_, i) => i + 11)
            .map(n => ({ et: String(n), es: [spanishNumber(n), String(n)] }))
        },
        {
          title: "21–39 (erandid sees)",
          items: [21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39]
            .map(n => ({ et: String(n), es: [spanishNumber(n), String(n)] }))
        },
        {
          title: "Kümnesed 40–100",
          items: [40,50,60,70,80,90,100]
            .map(n => ({ et: String(n), es: [spanishNumber(n), String(n)] }))
        },
        {
          title: "Seganumbrid (42, 53, 64, 75, 86, 97)",
          items: [42,53,64,75,86,97]
            .map(n => ({ et: String(n), es: [spanishNumber(n), String(n)] }))
        },
        {
          title: "Sajad 100–900",
          items: Array.from({ length: 9 }, (_, i) => (i + 1) * 100)
            .map(n => ({ et: String(n), es: [spanishNumber(n), String(n)] }))
        },
        {
          title: "Tuhat",
          items: [{ et: "1000", es: [spanishNumber(1000), "1000"] }]
        }
      ];
    }

    function buildNumberPool() {
      const pool = [];
      for (let i = 1; i <= 1000; i++) {
        pool.push({ et: String(i), es: [spanishNumber(i), String(i)] });
      }
      return pool;
    }

    function randomSample(arr, n) {
      const copy = arr.slice();
      for (let i = copy.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [copy[i], copy[j]] = [copy[j], copy[i]];
      }
      return copy.slice(0, n);
    }

    // -------- MUUTUJAD --------

    let currentWords = [];
    let currentWord = null;
    let usedIndices = [];
    let results = [];
    let currentMode = null;
    let currentVocabCategory = null;
    let currentNumberGroup = 0;
    const numberVocabGroups = buildNumberVocabGroups();
    let lastResult = null;

    let recognition = null;
    let recognizing = false;

    // -------- ABI --------

    function normalize(str) {
      return String(str || "")
        .toLowerCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")  // PARANDATUD regex
        .trim();
    }

    function speak(text, lang) {
      if (!("speechSynthesis" in window)) return;
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = lang;
      window.speechSynthesis.speak(utterance);
    }

    function showInitial() {
      document.getElementById("initial-select").style.display = "block";
      document.getElementById("vocab-area").style.display = "none";
@@ -535,67 +527,119 @@
      summaryDiv.innerHTML = html;
    }

    function showSummary() {
      document.getElementById("quiz-area").style.display = "none";
      renderSummary();
      document.getElementById("initial-select").style.display = "block";
    }

    function restartApp() {
      currentMode = null;
      currentWords = [];
      usedIndices = [];
      results = [];
      lastResult = null;
      currentWord = null;
      document.getElementById("feedback").textContent = "";
      document.getElementById("answer-input").value = "";
      document.getElementById("summary").innerHTML = "";
      document.getElementById("estonian-word").textContent =
        "Vali uuesti blokk ja vajuta “Järgmine”.";
      renderLastResult();
      showInitial();
    }

    // -------- Sõnavara vaatamine --------
    function showVocab(category) {
    function renderVocabTable(items, title) {
      const listDiv = document.getElementById('vocab-list');
      let items = [];
      if (category === 'body') items = bodyWords.slice();
      else if (category === 'days') items = daysAndDirs.slice();
      else if (category === 'numbers') items = buildNumberVocab();

      let html = '<h3>Sõnavara: ' + (category === 'body' ? 'Kehaosad' : category === 'days' ? 'Päevad ja suunad' : 'Numbrid') + '</h3>';
      let html = `<h3>${title}</h3>`;
      html += "<table><tr><th>Eesti</th><th>Hispaania (näide)</th></tr>";
      items.forEach(function(it) {
        html += '<tr><td>' + it.et + '</td><td>' + (Array.isArray(it.es) ? it.es.slice(0,3).join(', ') : it.es) + '</td></tr>';
      });
      html += '</table>';
      listDiv.innerHTML = html;
    }

    function renderNumberGroup() {
      const note = document.getElementById('vocab-note');
      const listDiv = document.getElementById('vocab-list');
      const clampedIndex = Math.max(0, Math.min(numberVocabGroups.length - 1, currentNumberGroup));
      currentNumberGroup = clampedIndex;
      const group = numberVocabGroups[currentNumberGroup];
      const progress = `Blokk ${currentNumberGroup + 1} / ${numberVocabGroups.length}`;

      let html = `<h3>Numbrid – ${group.title}</h3>`;
      html += '<div class="vocab-nav">'
            + `<button id="num-prev" ${currentNumberGroup === 0 ? 'disabled' : ''}>Eelmine blokk</button>`
            + `<div class="muted">${progress}</div>`
            + `<button id="num-next" ${currentNumberGroup === numberVocabGroups.length - 1 ? 'disabled' : ''}>Järgmine blokk</button>`
            + '</div>';

      html += "<table><tr><th>Number</th><th>Hispaania</th></tr>";
      group.items.forEach(function(it) {
        html += '<tr><td>' + it.et + '</td><td>' + (Array.isArray(it.es) ? it.es[0] : it.es) + '</td></tr>';
      });
      html += '</table>';

      listDiv.innerHTML = html;
      note.textContent = 'Numbrid on jagatud väiksemateks plokkideks, et vahetada edasi-tagasi ilma lehte hangumata.';

      document.getElementById('num-prev').onclick = function() {
        if (currentNumberGroup > 0) {
          currentNumberGroup -= 1;
          renderNumberGroup();
        }
      };
      document.getElementById('num-next').onclick = function() {
        if (currentNumberGroup < numberVocabGroups.length - 1) {
          currentNumberGroup += 1;
          renderNumberGroup();
        }
      };
    }

    // -------- Sõnavara vaatamine --------
    function showVocab(category) {
      currentVocabCategory = category;
      document.querySelectorAll('.pill-row button').forEach(btn => btn.classList.remove('active'));

      if (category === 'body') {
        document.getElementById('vocab-body').classList.add('active');
        document.getElementById('vocab-note').textContent = 'Kehaosad on toodud koos levinud variatsioonidega.';
        renderVocabTable(bodyWords.slice(), 'Sõnavara: Kehaosad');
      } else if (category === 'days') {
        document.getElementById('vocab-days').classList.add('active');
        document.getElementById('vocab-note').textContent = 'Päevad ja suunad.';
        renderVocabTable(daysAndDirs.slice(), 'Sõnavara: Päevad ja suunad');
      } else if (category === 'numbers') {
        document.getElementById('vocab-numbers').classList.add('active');
        currentNumberGroup = 0;
        renderNumberGroup();
      }
    }

    // -------- NUPUD --------

    const selectVocabBtn = document.getElementById('select-vocab');
    const selectQuizBtn = document.getElementById('select-quiz');
    const vocabArea = document.getElementById('vocab-area');
    const vocabBodyBtn = document.getElementById('vocab-body');
    const vocabNumbersBtn = document.getElementById('vocab-numbers');
    const vocabDaysBtn = document.getElementById('vocab-days');
    const vocabBackBtn = document.getElementById('vocab-back');

    const modeBodyBtn = document.getElementById("mode-body");
    const modeNumbersBtn = document.getElementById("mode-numbers");
    const modeDaysBtn = document.getElementById("mode-days");
    const nextBtn = document.getElementById("next-btn");
    const checkBtn = document.getElementById("check-btn");
    const checkBtnInline = document.getElementById("check-btn-inline");
    const restartBtn = document.getElementById("restart-btn");
    const cancelBtn = document.getElementById("cancel-btn");
    const answerInput = document.getElementById("answer-input");
    const micBtn = document.getElementById('mic-btn');

    selectVocabBtn.onclick = function() {
      document.getElementById('initial-select').style.display = 'none';
      vocabArea.style.display = 'block';
      document.getElementById('vocab-note').textContent = 'Vali kategooria, et näha tabelit sõnadest, mida hetkel saab kontrollida.';
